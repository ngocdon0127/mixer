jQuery.fn.flexdatalist=function(a,b){"use strict";var e,c=$(document),d=$(this),f=this;if(e=function(){var c,d,b=$(this),e={},g="",h=null;b.attr("name");b.hasClass("flexdatalist-set")&&f._destroy(b),f._options(b,$.extend({url:null,data:[],params:{},relatives:null,chainedRelatives:!1,cache:!0,minLength:2,groupBy:!1,selectionRequired:!1,focusFirstResult:!1,textProperty:null,valueProperty:null,visibleProperties:[],searchIn:["label"],searchContain:!1,searchEqual:!1,searchByWord:!1,searchDisabled:!1,normalizeString:null,multiple:b.is("[multiple]"),maxShownResults:100,noResultsText:'No results found for "{keyword}"',toggleSelected:!1,allowDuplicateValues:!1,requestType:"get",limitOfValues:0,_values:[],valuesSeparator:","},b.data(),"object"==typeof a?a:{})),b._options=function(a,c){return f._options(b,a,c)},c=b.clone(!1).attr({list:null,name:null,id:b.attr("id")?b.attr("id")+"-flexdatalist":null}).addClass("flexdatalist-alias").removeClass("flexdatalist"),b._options("multiple")?(d=$("<ul>").addClass("flexdatalist-multiple").css({"border-color":b.css("border-left-color"),"border-width":b.css("border-left-width"),"border-style":b.css("border-left-style"),"border-radius":b.css("border-top-left-radius"),"background-color":b.css("background-color")}).insertAfter(b).click(function(){$(this).find("input").focus()}),$('<li class="input-container">').addClass("flexdatalist-multiple-value").append(c).appendTo(d)):c.insertAfter(b),c.attr("autofocus")&&c.focus(),b._init=function(){var a=b._options();c.on("input keydown",function(d){var e=b._keyword();188!==f._keyNum(d)&&13!==f._keyNum(d)||a.selectionRequired||!a.multiple||b._resultSelected()?9===f._keyNum(d)?b._removeResults():0===e.length&&a.multiple&&8===f._keyNum(d)&&c.data("_remove",c.parents("li:eq(0)").prev()):(d.preventDefault(),b._value(e),b._removeResults())}).on("input keyup",function(d){if(b._changed()&&13!==f._keyNum(d)){var e=b._keyword();a.multiple||(a._values=[],a.selectionRequired?b._value(""):b._value(e)),e.length>=a.minLength?b._search(function(a){b._showResults(a)}):b._removeResults()}var h=c.data("_remove");h&&(h.find(".fdl-remove").click(),c.data("_remove",null)),g=b._keyword()}).on("focus",function(){var c=b._keyword();0===a.minLength?""===c&&b._tdata(function(a){b._showResults(a)}):c.length>=a.minLength&&!b._selected()&&b._search(function(a){b._showResults(a)})}).on("blur",function(){b._resultSelected()||!a.multiple||a.selectionRequired||b._value(b._keyword())}).attr("autocomplete","off"),window.onresize=function(a){b._position()},b.addClass("flexdatalist flexdatalist-set").prop("type","hidden")},b._resultSelected=function(){return $("ul.flexdatalist-results").find("li.item.active").length>0},b._changed=function(){return g!==b._keyword()},b._chained=function(){var a=b._options();if(a.relatives&&a.chainedRelatives){var g=function(e){a.relatives.each(function(){var g=f._isEmpty($(this).val()),h=f._isEmpty(b.val());c.prop("disabled",g),e||!g&&h||(b._value(""),c.val(""),a.multiple&&d.find("li .fdl-remove").click()),d&&(g&&d?d.addClass("disabled"):d.removeClass("disabled"))})};a.relatives.on("change",function(){g(),e={}}),g(!0)}},b._initValue=function(){var a=b.attr("value");f._isEmpty(a)||(b._options("originalValue",b.val()),b._parseValue(a,function(a){b.val("",!0),c.val(""),f._isEmpty(a)||b._values(a,!0),g=b._keyword()}))},b._parseValue=function(a,c){var d=b._options();if(b._toJSON())try{c(JSON.parse(a))}catch(a){}else if(b._toCSV()||"string"==typeof d.valueProperty){var e=a.split(d.valuesSeparator);if("string"==typeof d.valueProperty){var f=d.searchIn;d.searchIn=d.valueProperty.split(","),d.searchEqual=!0,b._search(function(a){a.length>0&&c(a),d.searchIn=f,d.searchEqual=!1},e)}else c(e)}else c(a)},b._tdata=function(a){b.trigger("before:flexdatalist.data"),b._url(function(c){b._data(function(d){d=d.concat(c);for(var e=b._options("_values"),f=0;f<d.length;f++){var g=d[f];e&&e.indexOf(b._getText(g))>-1&&delete d[f]}b.trigger("after:flexdatalist.data",[d]),a(d)})})},b._data=function(a){var c=b._options();"string"==typeof c.data?b._remote({url:c.data,success:function(d){var e=b._getRemoteData(d);c.data=e,a(e)}}):a(c.data)},b._url=function(a){var c=b._options(),d=b._keyword(),e=b.val(),g=d;return f._isEmpty(c.url)?a([]):(clearTimeout(h),void(h=setTimeout(function(){c.cache&&2!==c.cache&&(g=d.substring(0,c.minLength>0?c.minLength:1));var f=b._cache(g);if(f&&c.cache)return void a(f);var h={};"post"==c.requestType&&($.each(c,function(a,b){0!=a.indexOf("_")&&(h[a]=b)}),delete h.relatives),b._remote({url:c.url,data:$.extend(b._relativesData(),c.params,{keyword:d,contain:c.searchContain,selected:e,options:h}),success:function(c){var e=b._getRemoteData(c),f=b._keyword();f.length>=d.length&&a(e),b._cache(g,e)}})},200)))},b._remote=function(a){b.hasClass("flexdatalist-loading")||(b.addClass("flexdatalist-loading"),a=$.extend({type:b._options("requestType"),dataType:"json",complete:function(){b.removeClass("flexdatalist-loading")}},a),$.ajax(a))},b._getRemoteData=function(a){var c=a.results?a.results:a;return"string"==typeof c&&0===c.indexOf("[{")&&(c=JSON.parse(c)),c.options&&f._options(b,c.options),f._isObject(c)?c:[]},b._relativesData=function(){var a=b._options("relatives"),c={};return a&&(c.relatives={},a.each(function(){var a=$(this),b=a.attr("name").split("][").join("-").split("]").join("-").split("[").join("-").replace(/^\|+|\-+$/g,"");c.relatives[b]=a.val()})),c},b._datalist=function(){var a=b._options(),c=b.attr("list");return f._isEmpty(c)||(a.data=[],$("#"+c).find("option").each(function(){var b=$(this),c=b.val(),d=b.text();a.data.push({label:d.length>0?d:c,value:c})})),b},b._cache=function(a,c){if(b._options("cache")){if(a=b._normalizeString(a),!f._isDefined(c))return f._isDefined(e,a)&&(c=e[a]),c;e[a]=c}return null},b._search=function(a,c){b._tdata(function(d){var e=[],g=b._options();if(g.searchDisabled)return a(d);f._isDefined(c)||(c=b._keyword()),b.trigger("before:flexdatalist.search",[c,d]),c=b._split(c);for(var h=0;h<d.length;h++){var i=b._matches(d[h],c);i&&e.push(i)}b.trigger("after:flexdatalist.search",[c,d,e]),a(e)})},b._matches=function(a,c){var e=$.extend({},a),g=b._options(),h=[],i=g.searchIn;if(c.length>0)for(var j=0;j<i.length;j++){var k=i[j];if(f._isDefined(a,k)&&a[k]){for(var l=a[k].toString(),m=l,n=b._split(l),o=0;o<c.length;o++){var p=c[o];b._find(p,n)&&(h.push(p),m=b._highlight(p,m))}m!==l&&(e[k+"_highlight"]=b._highlight(m))}}return!(0===h.length||g.searchByWord&&h.length<c.length-1)&&e},b._highlight=function(a,c){return c?c.replace(new RegExp(a,b._options("searchContain")?"ig":"i"),"|:|$&|::|"):(a=a.split("|:|").join('<span class="highlight">'),a.split("|::|").join("</span>"))},b._find=function(a,c){for(var d=b._options(),e=0;e<c.length;e++){var f=c[e];if(f=b._normalizeString(f),a=b._normalizeString(a),d.searchEqual&&f==a)return!0;if(d.searchContain?f.indexOf(a)>=0:0===f.indexOf(a))return!0}return!1},b._split=function(a){"string"==typeof a&&(a=[$.trim(a)]);var c=b._options();if(c.searchByWord)for(var d=0;d<a.length;d++){var e=$.trim(a[d]);if(e.indexOf(" ")>0){var f=e.split(" ");$.merge(a,f)}}return a},b._showResults=function(a){b._removeResults(!0);var c=b._options();if(0===a.length)return void b._noResults(c.noResultsText);var d=b._getResultsContainer();c.groupBy?(a=b._groupData(a),Object.keys(a).forEach(function(e,f){var g=a[e],h=c.groupBy,i=b._getHighlight(g[0],h,e);$("<li>").addClass("group").append($("<span>").addClass("group-name").html(i)).append($("<span>").addClass("group-item-count").text(" "+g.length)).appendTo(d);b._items(g,d)})):b._items(a,d);var e=d.find("li:not(.group)");e.on("click",function(a){var d=$(this).data("item");d&&(b._selected(!0)._removeResults()._value(d),b.trigger("select:flexdatalist",[d,c]))}).hover(function(){e.removeClass("active"),$(this).addClass("active")},function(){$(this).removeClass("active")}),c.focusFirstResult&&e.filter(":first").addClass("active")},b._noResults=function(a){if(!f._isEmpty(a)){var c=b._getResultsContainer(),d=b._keyword();a=a.split("{keyword}").join(d),$("<li>").addClass("item no-results").append(a).appendTo(c)}},b._groupData=function(a){for(var c=[],d=b._options("groupBy"),e=0;e<a.length;e++){var g=a[e];if(f._isDefined(g,d)){var h=g[d];f._isDefined(c,h)||(c[h]=[]),c[h].push(g)}}return c},b._items=function(a,c){var d=b._options("maxShownResults");b.trigger("show:flexdatalist.results",[a]);for(var e=0;e<a.length&&!(d>0&&d===e);e++)b._item(a[e]).appendTo(c);b.trigger("shown:flexdatalist.results",[a])},b._item=function(a){for(var c=$("<li>").data("item",a).addClass("item"),d=b._options(),e=d.visibleProperties,g=0;g<e.length;g++){var h=e[g];if((!d.groupBy||d.groupBy!==h)&&f._isDefined(a,h)){var i={};if("thumb"===h)i=$("<img>").addClass("item item-"+h).attr("src",a[h]);else{var j=b._getHighlight(a,h);i=$("<span>").addClass("item item-"+h).html(j+" ")}i.appendTo(c)}}return c},b._getHighlight=function(a,b,c){return f._isDefined(a,b+"_highlight")?a[b+"_highlight"]:f._isDefined(a,b)?a[b]:c},b._getResultsContainer=function(){var a=b;b._options("multiple")&&(a=d);var e=$("ul.flexdatalist-results");return 0===e.length&&(e=$("<ul>").addClass("flexdatalist-results").appendTo("body").css({"border-color":a.css("border-left-color"),"border-width":"1px","border-bottom-left-radius":a.css("border-bottom-left-radius"),"border-bottom-right-radius":a.css("border-bottom-right-radius")}).data("target",c),b._position()),e},b._removeResults=function(a){var c="ul.flexdatalist-results";return a&&(c="ul.flexdatalist-results li"),$(c).remove(),b},b._selected=function(a){var c="flexdatalist-selected";return f._isDefined(a)?(a?b.addClass(c):b.removeClass(c),b):b.hasClass(c)},b._values=function(a,c){return $.isArray(a)&&!f._isEmpty(a)?void $.each(a,function(a,d){b._value(d,c)}):void b._value(a,c)},b._value=function(a,e){var f=b._options(),h=b._getText(a),i=b._getValue(a);if(h.length>0&&!f.allowDuplicateValues&&f._values.push(h),f.multiple){if(""===a)return b;c.val("");var j=d.find("li.input-container"),k=$("<li>").addClass("value"+(f.toggleSelected?" toggle":"")).append('<span class="text">'+h+"</span>").append('<span class="fdl-remove">&times;</span>').insertBefore(j);j.find("input").focus(),k.find("span.fdl-remove").click(function(){var a=$(this).parent(),c=a.index();if(!a.hasClass("disabled")&&(b._toJSON()||b._toCSV())){var d=b._normalizeValue();d.splice(c,1),f._values.splice(c,1),b._normalizeValue(d),b._allowValues()}a.remove()}),f.toggleSelected&&k.click(function(){var a=$(this),c=b._normalizeValue(),d=a.index();if(a.hasClass("disabled")){var e=a.data("_value");c.splice(d,0,e),f._values.splice(d,0,b._getText(e)),a.removeClass("disabled")}else{var e=c.splice(d,1);a.data("_value",e[0]),f._values.splice(d,1),a.addClass("disabled")}b._normalizeValue(c,h)})}else h&&h!==c.val()&&c.val(h);return b._normalizeValue(i,h,e),g=b._keyword(),b},b._normalizeValue=function(a,c,d){var e=b._toJSON(),h=(b._options(),b._toCSV());return f._isDefined(a)?(b._allowValues(),f._isObject(a)&&(e&&!f._isEmpty(a)?a=JSON.stringify(a):h&&(a=a.join(b._options("valuesSeparator")))),a==b.val()?a:(""===a&&b._options("_values",[]),b.val(a,!0),!d&&b._changed()&&b.trigger("change:flexdatalist",[a,c,b._options()]).trigger("change"),a)):(a=b.val(),a?e?a=JSON.parse(a):h&&(a=a.split(b._options("valuesSeparator"))):(e||h)&&(a=[]),a)},b._getText=function(a){var c=a,d=b._options();return f._isObject(a)&&(c=a[d.searchIn[0]],c=f._isDefined(a,d.textProperty)?a[d.textProperty]:b._replacePlaceholders(a,d.textProperty,c)),$("<div>").html(c).text()},b._getValue=function(a){var c=a,d=b._options();if(f._isObject(a))if(c=a[d.searchIn[0]],"*"===d.valueProperty)c=a;else if(f._isDefined(a,d.valueProperty))c=a[d.valueProperty];else if(b._toJSON()){var c={},e=d.valueProperty,g=d.textProperty;if(g){var h=g;"string"==typeof g&&(h=b._parsePlaceholders(g)),f._isObject(h)&&$.each(h,function(a,b){e.push(b)})}else f._isDefined(a,g)&&e.push(g);$.each(e,function(b,d){f._isDefined(a,d)&&(c[d]=a[d])})}if(d.multiple&&(b._toJSON()||b._toCSV())){var i=b._normalizeValue();!f._isEmpty(c)&&f._isObject(i)&&(i.push(c),c=i)}return c},b._replacePlaceholders=function(a,c,d){if(f._isObject(a)&&"string"==typeof c){var e=b._parsePlaceholders(c);if(!f._isEmpty(a)&&e)return $.each(e,function(b,d){f._isDefined(a,d)&&(c=c.replace(b,a[d]))}),c}return d},b._parsePlaceholders=function(a){var b=a.match(/\{.+?\}/g);if(b){var c={};return b.map(function(a){c[a]=a.slice(1,-1)}),c}return!1},b._allowValues=function(){var a=b._options();if(a.limitOfValues>0&&a.multiple){var c=d.find(".flexdatalist-multiple-value");a._values.length>=a.limitOfValues?c.hide():c.show()}},b._normalizeString=function(a){if("string"==typeof a){var c=b._options("normalizeString");return"function"==typeof c&&(a=c(a)),a.toUpperCase()}return a},b._keyword=function(){return c.val().replace(/^\s+/,"")},b._toJSON=function(){var a=b._options("valueProperty");return f._isObject(a)||"*"===a},b._toCSV=function(){return!b._toJSON()&&b._options("multiple")},b._position=function(){var a=c;b._options("multiple")&&(a=d),$("ul.flexdatalist-results").css({width:a.outerWidth()+"px",top:a.offset().top+a.outerHeight()+"px",left:a.offset().left+"px"})},b._init(),b._datalist(),b._chained(),b._initValue()},this._destroy=function(a){a||(a=d),a.each(function(){var a=$(this).data("flexdatalist");$(this).removeClass("flexdatalist-set").attr("type","text").val(a&&a.originalValue?a.originalValue:"").removeData("flexdatalist").next(".flexdatalist-alias, ul.flexdatalist-multiple").remove()})},this._reset=function(){this._destroy()},this._setValue=function(a){d.each(function(){var b=$(this),c=b.data("flexdatalist");if(f._isDefined(c)){if(c.originalValue=a,""==a)return b.val(a,!0),void(c.multiple&&b.next("ul.flexdatalist-multiple").find("li.value").remove());f._destroy()}})},this._keyNum=function(a){return a.which||a.keyCode},c.data("flexdatalist")||$(document).mouseup(function(a){var b=$(".flexdatalist-results"),c=b.data("target");c&&c.is(":focus")||b.is(a.target)||0!==b.has(a.target).length||b.remove()}).keydown(function(a){var b=$(".flexdatalist-results"),c=b.find("li"),d=c.filter(".active"),e=d.index(),g=c.length,h=f._keyNum(a);if(0!==g){if(27===f._keyNum(a))return b.remove();if(13===h)a.preventDefault(),d.click();else if(40===h||38===h){a.preventDefault(),40===h?d=e<g&&d.nextAll(".item").first().length>0?d.removeClass("active").nextAll(".item").first().addClass("active"):c.removeClass("active").filter(".item:first").addClass("active"):38===h&&(d=e>0&&d.prevAll(".item").first().length>0?d.removeClass("active").prevAll(".item").first().addClass("active"):c.removeClass("active").filter(".item:last").addClass("active"));var i=(0===d.prev().length?d:d.prev()).position().top;b.animate({scrollTop:i+b.scrollTop()},100)}}}).data("flexdatalist",!0),this._isEmpty=function(a){return!f._isDefined(a)||(null===a||a!==!0&&(0===this._length(a)||""===$.trim(a)))},this._isObject=function(a){return a&&"object"==typeof a},this._csvToArray=function(a,b){return 0===a.length?b:"string"==typeof a?a.split($this._options("valuesSeparator")):a},this._length=function(a){return this._isObject(a)?Object.keys(a).length:"number"==typeof a.length?a.length:0},this._isDefined=function(a,b){var c="undefined"!=typeof a;return c&&"undefined"!=typeof b?"undefined"!=typeof a[b]:c},this._options=function(a,b,c){var d=a.data("flexdatalist");if(f._isDefined(b)){if(f._isDefined(c))d[b]=c;else{if(!f._isObject(b))return f._isDefined(d,b)?d[b]:null;d=b}d.searchIn=f._csvToArray(d.searchIn),d.relatives=d.relatives&&$(d.relatives).length>0?$(d.relatives):null,d.textProperty=null===d.textProperty?d.searchIn[0]:d.textProperty,d.visibleProperties=f._csvToArray(d.visibleProperties,d.searchIn),a.data("flexdatalist",d)}return d},"string"==typeof a)if("function"==typeof this["_"+a]){if(!this["_"+a]())return this}else{if("value"!==a)return b?(f._options(d,a,b),this):f._options(d,a);this._setValue(b)}return this.each(e)};var _defaultValFunc=jQuery.fn.val;jQuery.fn.val=function(a,b){return!b&&$(this).hasClass("flexdatalist-set")&&"undefined"!=typeof a&&$(this).flexdatalist("value",a),_defaultValFunc.apply(this,arguments)},$(function(){$("input.flexdatalist:not(.flexdatalist-set)").flexdatalist()});